# CHƯƠNG 3: QUY TRÌNH NGHIỆP VỤ

---

## 3.1. Quy trình Đăng nhập Hệ thống

### 3.1.1. Flowchart Đăng nhập

```
                    +-------------------+
                    |     BẮT ĐẦU       |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | Nhập username &   |
                    | password          |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | Kiểm tra username |
                    | tồn tại?          |
                    +--------+----------+
                             |
              +--------------+--------------+
              | KHÔNG                       | CÓ
              v                             v
    +-------------------+         +-------------------+
    | Hiển thị lỗi      |         | Kiểm tra password |
    | "Tài khoản không  |         | đúng?             |
    | tồn tại"          |         +--------+----------+
    +--------+----------+                  |
             |                  +----------+-----------+
             |                  | KHÔNG                | ĐÚNG
             |                  v                      v
             |        +-------------------+  +-------------------+
             |        | Hiển thị lỗi      |  | Kiểm tra is_locked|
             |        | "Sai mật khẩu"    |  | = 0?              |
             |        +--------+----------+  +--------+----------+
             |                 |                      |
             |                 |           +----------+----------+
             |                 |           | KHÔNG               | CÓ
             |                 |           v                     v
             |                 |  +-------------------+ +------------------+
             |                 |  | Hiển thị lỗi      | | Tạo SESSION      |
             |                 |  | "Tài khoản bị     | | user_id, role    |
             |                 |  | khóa"             | +--------+---------+
             |                 |  +--------+----------+          |
             |                 |           |                     v
             |                 |           |           +-------------------+
             |                 |           |           | role = 'admin'?   |
             |                 |           |           +--------+----------+
             |                 |           |                    |
             |                 |           |         +----------+----------+
             |                 |           |         | CÓ                 | KHÔNG
             |                 |           |         v                    v
             |                 |           | +---------------+  +---------------+
             |                 |           | | Redirect      |  | Redirect      |
             |                 |           | | dashboard.php |  | pos.php       |
             |                 |           | +-------+-------+  +-------+-------+
             |                 |           |         |                  |
             +--------+--------+-----------+---------+------------------+
                      |
                      v
                    +-------------------+
                    |     KẾT THÚC      |
                    +-------------------+
```

---

## 3.2. Quy trình Bán hàng POS (Người 2 - An)

### 3.2.1. Flowchart Bán hàng

```
                    +-------------------+
                    |     BẮT ĐẦU       |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | Hiển thị lưới     |
                    | sản phẩm theo     |
                    | danh mục          |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | Khách chọn        |
                    | sản phẩm          |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | Mở Modal chọn     |
                    | Size/Đá/Topping   |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | Kiểm tra stock    |
                    | sản phẩm          |
                    +--------+----------+
                             |
              +--------------+--------------+
              | stock = 0                   | stock > 0
              v                             v
    +-------------------+         +-------------------+
    | Cảnh báo          |         | Thêm vào giỏ hàng |
    | "Hết hàng!"       |         | (JavaScript cart) |
    +--------+----------+         +--------+----------+
             |                             |
             v                             v
    +-------------------+         +-------------------+
    | Quay lại chọn     |         | Cập nhật badge    |
    | sản phẩm khác     |         | số lượng giỏ hàng |
    +--------+----------+         +--------+----------+
             |                             |
             +--------------+--------------+
                            |
                            v
                    +-------------------+
                    | Khách muốn        |
                    | thanh toán?       |
                    +--------+----------+
                             |
              +--------------+--------------+
              | KHÔNG                       | CÓ
              v                             v
    (Quay lại chọn thêm)        +-------------------+
                                | Mở Modal giỏ hàng |
                                | Hiển thị tất cả   |
                                | món đã chọn       |
                                +--------+----------+
                                         |
                                         v
                                +-------------------+
                                | Nhấn nút          |
                                | THANH TOÁN        |
                                +--------+----------+
                                         |
                                         v
                            (Chuyển sang quy trình 3.3)
```

### 3.2.2. Sơ đồ Luồng Dữ liệu - Chọn món

```
+-------------+     Chọn món      +-----------------+
|   Khách     | ----------------> |   pos.php       |
|   hàng      |                   |   (JavaScript)  |
+-------------+                   +--------+--------+
                                           |
                                           v
                                  +-----------------+
                                  | Đọc data-stock, |
                                  | data-id từ HTML |
                                  +--------+--------+
                                           |
                                           v
                                  +-----------------+
                                  | Lưu vào biến    |
                                  | cart (JS Object)|
                                  +--------+--------+
                                           |
                                           v
                                  +-----------------+
                                  | Render giỏ hàng |
                                  | Modal           |
                                  +-----------------+
```

---

## 3.3. Quy trình Thanh toán (Người 2 - An)

### 3.3.1. Flowchart Thanh toán

```
                    +-------------------+
                    |     BẮT ĐẦU       |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | Kiểm tra giỏ hàng |
                    | có trống không?   |
                    +--------+----------+
                             |
              +--------------+--------------+
              | TRỐNG                       | CÓ MÓN
              v                             v
    +-------------------+         +-------------------+
    | Cảnh báo          |         | Gửi dữ liệu cart  |
    | "Giỏ hàng trống!" |         | đến server        |
    +--------+----------+         | (AJAX POST)       |
             |                    +--------+----------+
             v                             |
         (Kết thúc)                        v
                                  +-------------------+
                                  | checkout_process  |
                                  | .php nhận data    |
                                  +--------+----------+
                                           |
                                           v
                                  +-------------------+
                                  | Kiểm tra từng món |
                                  | có đủ tồn kho?    |
                                  +--------+----------+
                                           |
                              +------------+------------+
                              | KHÔNG ĐỦ                | ĐỦ
                              v                         v
                    +-------------------+     +-------------------+
                    | Trả về lỗi        |     | BEGIN TRANSACTION |
                    | "Không đủ hàng"   |     +--------+----------+
                    +--------+----------+              |
                             |                         v
                             |               +-------------------+
                             |               | 1. INSERT orders  |
                             |               | (tạo đơn mới)     |
                             |               +--------+----------+
                             |                        |
                             |                        v
                             |               +-------------------+
                             |               | 2. Lấy order_id   |
                             |               | (LAST_INSERT_ID)  |
                             |               +--------+----------+
                             |                        |
                             |                        v
                             |               +-------------------+
                             |               | 3. INSERT         |
                             |               | order_details     |
                             |               | (từng món)        |
                             |               +--------+----------+
                             |                        |
                             |                        v
                             |               +-------------------+
                             |               | 4. UPDATE products|
                             |               | SET stock = stock |
                             |               | - quantity        |
                             |               +--------+----------+
                             |                        |
                             |                        v
                             |               +-------------------+
                             |               | 5. INSERT         |
                             |               | inventory_history |
                             |               | (log xuất kho)    |
                             |               +--------+----------+
                             |                        |
                             |                        v
                             |               +-------------------+
                             |               | COMMIT TRANSACTION|
                             |               +--------+----------+
                             |                        |
                             |                        v
                             |               +-------------------+
                             |               | Trả về success    |
                             |               | Xóa giỏ hàng JS   |
                             |               +--------+----------+
                             |                        |
                             +------------------------+
                                              |
                                              v
                                    +-------------------+
                                    |     KẾT THÚC      |
                                    +-------------------+
```

---

## 3.4. Quy trình Nhập hàng (Người 3 - Danh)

### 3.4.1. Flowchart Nhập hàng

```
                    +-------------------+
                    |     BẮT ĐẦU       |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | Truy cập trang    |
                    | inventory_import  |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | Hiển thị danh     |
                    | sách sản phẩm     |
                    | (tên, tồn hiện    |
                    |  tại, giá)        |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | Nhân viên nhập:   |
                    | - Số lượng nhập   |
                    | - Giá vốn mới     |
                    |   (nếu thay đổi)  |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | Nhấn "Lưu"        |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | Với mỗi sản phẩm  |
                    | có số lượng > 0:  |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | UPDATE products   |
                    | SET stock =       |
                    |   stock + qty     |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | Giá vốn mới > 0?  |
                    +--------+----------+
                             |
              +--------------+--------------+
              | KHÔNG                       | CÓ
              |                             v
              |                   +-------------------+
              |                   | UPDATE products   |
              |                   | SET cost_price =  |
              |                   |   new_price       |
              +--------+----------+--------+----------+
                       |                   |
                       +--------+----------+
                                |
                                v
                    +-------------------+
                    | INSERT            |
                    | inventory_history |
                    | quantity = +qty   |
                    | note = "Nhập hàng |
                    |         nhanh"    |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | Hiển thị thông    |
                    | báo thành công    |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    |     KẾT THÚC      |
                    +-------------------+
```

---

## 3.5. Quy trình Giao ca (Người 3 - Danh)

### 3.5.1. Flowchart Giao ca

```
                    +-------------------+
                    |     BẮT ĐẦU       |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | Xác định ca       |
                    | hiện tại          |
                    | (Sáng/Chiều/Tối)  |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | Tính doanh thu    |
                    | từ orders trong   |
                    | khung giờ ca      |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | Hiển thị:         |
                    | - Doanh thu hệ    |
                    |   thống           |
                    | - Input tiền thực |
                    |   tế              |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | Nhân viên nhập:   |
                    | - Tiền thực tế    |
                    | - Ghi chú kho     |
                    | - Ghi chú chung   |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | Tính chênh lệch   |
                    | = Thực tế -       |
                    |   Hệ thống        |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | Chênh lệch = 0?   |
                    +--------+----------+
                             |
              +--------------+--------------+
              | KHÔNG                       | ĐÚNG
              v                             v
    +-------------------+         +-------------------+
    | Cảnh báo màu đỏ   |         | Hiển thị màu xanh |
    | "Thiếu/Thừa X đ"  |         | "KHỚP"            |
    +--------+----------+         +--------+----------+
             |                             |
             +-------------+---------------+
                           |
                           v
                    +-------------------+
                    | Nhấn "Chốt ca"    |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | INSERT vào bảng   |
                    | shift_reports     |
                    | Lưu toàn bộ dữ    |
                    | liệu ca           |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | Hiển thị thông    |
                    | báo "Chốt ca      |
                    | thành công"       |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    |     KẾT THÚC      |
                    +-------------------+
```

### 3.5.2. Logic Xác định Ca tự động

```
+-------------------------------------------------------------------+
|                  XÁC ĐỊNH CA LÀM VIỆC                             |
+-------------------------------------------------------------------+
|                                                                   |
|   Giờ hiện tại (H)                                                |
|   |                                                               |
|   +--- H >= 6 && H < 12  -----> CA SÁNG (06:00 - 11:59)           |
|   |                                                               |
|   +--- H >= 12 && H < 18 -----> CA CHIỀU (12:00 - 17:59)          |
|   |                                                               |
|   +--- H >= 18 || H < 6  -----> CA TỐI (18:00 - 05:59)            |
|                                                                   |
+-------------------------------------------------------------------+
|  File: includes/auto_shift_check.php                              |
|                                                                   |
|  function get_current_shift() {                                   |
|      hour = date('H');                                            |
|      if (6 <= hour < 12) return 'Sáng';                           |
|      if (12 <= hour < 18) return 'Chiều';                         |
|      return 'Tối';                                                |
|  }                                                                |
+-------------------------------------------------------------------+
```

---

## 3.6. Quy trình Thống kê & Báo cáo (Người 3 - Danh)

### 3.6.1. Flowchart Thống kê

```
                    +-------------------+
                    |     BẮT ĐẦU       |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | Truy cập          |
                    | stats.php         |
                    +--------+----------+
                             |
                             v
            +----------------+----------------+
            |                |                |
            v                v                v
    +-------------+  +-------------+  +-------------+
    | DOANH THU   |  | LỢI NHUẬN   |  | MÓN BÁN     |
    | (Revenue)   |  | (Profit)    |  | CHẠY        |
    +------+------+  +------+------+  +------+------+
           |                |                |
           v                v                v
    +-------------+  +-------------+  +-------------+
    | SELECT SUM  |  | SELECT SUM  |  | SELECT      |
    | (total_     |  | ((price -   |  | product,    |
    | amount)     |  | cost_price) |  | SUM(qty)    |
    | FROM orders |  | * quantity) |  | GROUP BY    |
    |             |  | FROM order_ |  | ORDER BY    |
    |             |  | details     |  | SUM DESC    |
    +------+------+  +------+------+  +------+------+
           |                |                |
           +----------------+----------------+
                            |
                            v
                    +-------------------+
                    | Hiển thị Dashboard|
                    | - Thẻ thống kê    |
                    | - Biểu đồ         |
                    +--------+----------+
                             |
                             v
                    +-------------------+
                    | Người dùng muốn   |
                    | xuất Excel?       |
                    +--------+----------+
                             |
              +--------------+--------------+
              | KHÔNG                       | CÓ
              |                             v
              |                   +-------------------+
              |                   | Chọn loại xuất:   |
              |                   | - Theo tháng      |
              |                   | - Theo ngày       |
              |                   | - Theo khoảng     |
              |                   +--------+----------+
              |                            |
              |                            v
              |                   +-------------------+
              |                   | export_excel.php  |
              |                   | Tạo file .xls     |
              |                   +--------+----------+
              |                            |
              |                            v
              |                   +-------------------+
              |                   | Download file     |
              |                   +--------+----------+
              |                            |
              +----------------------------+
                                   |
                                   v
                    +-------------------+
                    |     KẾT THÚC      |
                    +-------------------+
```

### 3.6.2. Công thức Tính Lợi nhuận

```
+-------------------------------------------------------------------+
|                    CÔNG THỨC LỢI NHUẬN                            |
+-------------------------------------------------------------------+
|                                                                   |
|   Lợi nhuận = Σ (Giá bán - Giá vốn) × Số lượng                    |
|                                                                   |
|   SQL Query:                                                      |
|   +---------------------------------------------------------+     |
|   | SELECT SUM((od.price - p.cost_price) * od.quantity)     |     |
|   | FROM order_details od                                   |     |
|   | JOIN products p ON od.product_id = p.id                 |     |
|   | JOIN orders o ON od.order_id = o.id                     |     |
|   | WHERE DATE(o.order_date) = '2024-12-28'                 |     |
|   +---------------------------------------------------------+     |
|                                                                   |
|   Ví dụ:                                                          |
|   +----------------+----------+----------+------+------------+    |
|   | Sản phẩm       | Giá bán  | Giá vốn  | SL   | Lợi nhuận  |    |
|   +----------------+----------+----------+------+------------+    |
|   | Bạc xỉu        | 45,000   | 10,500   | 10   | 345,000    |    |
|   | Cốt dừa cà phê | 59,000   | 17,000   | 5    | 210,000    |    |
|   | Kem muối       | 9,000    | 800      | 20   | 164,000    |    |
|   +----------------+----------+----------+------+------------+    |
|   | TỔNG           |          |          | 35   | 719,000    |    |
|   +----------------+----------+----------+------+------------+    |
+-------------------------------------------------------------------+
```

---

## 3.7. Sơ đồ Luồng Dữ liệu Tổng quát (DFD Level 0)

```
+-------------------------------------------------------------------+
|                         DFD LEVEL 0                               |
+-------------------------------------------------------------------+

    +---------+                                      +---------+
    |  ADMIN  |                                      | THU NGÂN|
    +----+----+                                      +----+----+
         |                                                |
         | Thông tin                          Chọn món    |
         | sản phẩm,                          thanh toán  |
         | nhân viên                                      |
         v                                                v
    +----+----+        +-------------+        +----+------+
    | Quản lý |------->|   HỆ THỐNG  |<-------|  Bán hàng |
    | danh mục|<-------| CỘNG CÀ PHÊ |------->|    POS    |
    +---------+        +------+------+        +-----------+
                              |
              +---------------+---------------+
              |               |               |
              v               v               v
        +-----------+   +-----------+   +-----------+
        | DATABASE  |   | BÁO CÁO   |   | FILE XLS  |
        | MySQL     |   | THỐNG KÊ  |   | EXPORT    |
        +-----------+   +-----------+   +-----------+
```

---

## 3.8. Sơ đồ Luồng Dữ liệu Level 1 - Bán hàng

```
+-------------------------------------------------------------------+
|                    DFD LEVEL 1 - BÁN HÀNG                         |
+-------------------------------------------------------------------+

    +----------+
    | THU NGÂN |
    +----+-----+
         |
         | 1. Chọn sản phẩm
         v
    +----+-----+     Đọc products     +------------+
    | 1.0      |<--------------------| D1         |
    | Hiển thị |                     | products   |
    | menu     |-------------------->|            |
    +----+-----+     stock, price    +------------+
         |
         | 2. Thêm vào giỏ
         v
    +----+-----+
    | 2.0      |
    | Quản lý  |  (Local JavaScript)
    | giỏ hàng |
    +----+-----+
         |
         | 3. Thanh toán
         v
    +----+-----+     INSERT order     +------------+
    | 3.0      |-------------------->| D2         |
    | Xử lý    |                     | orders     |
    | thanh    |-------------------->+------------+
    | toán     |     INSERT details
    +----+-----+                      +------------+
         |       UPDATE stock        | D1         |
         +---------------------------->| products   |
         |                            +------------+
         |       INSERT log
         +---------------------------->+------------+
                                      | D3         |
                                      | inventory_ |
                                      | history    |
                                      +------------+
```

---

## Tóm tắt Chương 3

Chương này đã trình bày:
- Flowchart 6 quy trình nghiệp vụ chính
  - Đăng nhập hệ thống
  - Bán hàng POS
  - Thanh toán (Transaction)
  - Nhập hàng
  - Giao ca
  - Thống kê & Báo cáo
- Logic xác định ca tự động
- Công thức tính lợi nhuận
- Sơ đồ DFD Level 0 và Level 1

---

*[Tiếp theo: Chương 4 - Kết luận & Hướng phát triển]*
